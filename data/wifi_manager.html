<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Wiicon Setup</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta charset="UTF-8" />
    <link rel="icon" href="data:," />
    <link rel="stylesheet" type="text/css" href="style.css" />
  </head>
  <body>
    <div class="container">
      <div class="card">
        <div class="logo">
          <div class="logo-icon">
            <svg
              width="22"
              height="15"
              viewBox="0 0 22 15"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                d="M10.75 13.75H10.7618"
                stroke="#FFFFFF"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              />
              <path
                d="M7 10.75C9 8.75 12.5 8.75 14.5 10.75"
                stroke="#FFFFFF"
                stroke-width="1.5"
                stroke-linecap="round"
                stroke-linejoin="round"
              />
              <path
                d="M17.25 7.75C13.4824 4.41667 8.25 4.41667 4.25 7.75"
                stroke="#FFFFFF"
                stroke-width="1.5"
                stroke-linecap="round"
                stroke-linejoin="round"
              />
              <path
                d="M0.75 4.75C7.06579 -0.583309 14.4342 -0.583319 20.75 4.74989"
                stroke="#FFFFFF"
                stroke-width="1.5"
                stroke-linecap="round"
                stroke-linejoin="round"
              />
            </svg>
          </div>
          <h1>Wiicon Setup</h1>
          <p class="subtitle">Connect to your WiFi network</p>
        </div>

        <div id="status" class="status"></div>

        <button type="button" class="btn-scan" onclick="scanNetworks()">
          <svg
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <path d="M21 12a9 9 0 11-9-9c2.52 0 4.93 1 6.74 2.74L21 8" />
            <path d="M21 3v5h-5" />
          </svg>
          <span>Scan for Networks</span>
        </button>

        <form action="/" method="POST" id="wifiForm">
          <div class="form-group">
            <label for="ssid">WiFi Network</label>
            <select id="ssid" name="ssid" required>
              <option value="">Select a network...</option>
            </select>
          </div>

          <div class="form-group">
            <label for="password">Password</label>
            <input
              type="password"
              id="password"
              name="password"
              placeholder="Enter WiFi password"
            />
          </div>

          <div class="advanced-toggle" onclick="toggleAdvanced()">
            <svg
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
            <span>Static IP (optional - uses DHCP if empty)</span>
          </div>

          <div class="advanced-section" id="advancedSection">
            <p class="hint">Leave empty to use DHCP (automatic)</p>
            <div class="form-group">
              <label for="ip">IP Address</label>
              <input
                type="text"
                id="ip"
                name="ip"
                placeholder="Auto (DHCP)"
                pattern="^(\d{1,3}\.){3}\d{1,3}$"
              />
            </div>

            <div class="form-group">
              <label for="gateway">Gateway</label>
              <input
                type="text"
                id="gateway"
                name="gateway"
                placeholder="Auto (DHCP)"
                pattern="^(\d{1,3}\.){3}\d{1,3}$"
              />
            </div>
          </div>

          <button type="submit" class="btn-submit">Connect</button>
        </form>
      </div>
    </div>

    <script>
      let networks = [];

      function scanNetworks() {
        const btn = document.querySelector(".btn-scan");
        const select = document.getElementById("ssid");

        btn.classList.add("scanning");
        btn.disabled = true;
        btn.querySelector("span").textContent = "Scanning...";

        fetch("/scan")
          .then((response) => response.json())
          .then((data) => {
            networks = data.sort((a, b) => b.rssi - a.rssi);
            select.innerHTML = '<option value="">Select a network...</option>';

            const seen = new Set();
            networks.forEach((net) => {
              if (net.ssid && !seen.has(net.ssid)) {
                seen.add(net.ssid);
                const option = document.createElement("option");
                option.value = net.ssid;
                const signal = getSignalStrength(net.rssi);
                const lock = net.secure ? " ðŸ”’" : "";
                option.textContent = `${net.ssid} (${signal})${lock}`;
                select.appendChild(option);
              }
            });

            showStatus(`Found ${seen.size} network(s)`, "success");
          })
          .catch((err) => {
            showStatus("Failed to scan networks", "error");
            console.error(err);
          })
          .finally(() => {
            btn.classList.remove("scanning");
            btn.disabled = false;
            btn.querySelector("span").textContent = "Scan for Networks";
          });
      }

      function getSignalStrength(rssi) {
        if (rssi >= -50) return "Excellent";
        if (rssi >= -60) return "Good";
        if (rssi >= -70) return "Fair";
        return "Weak";
      }

      function toggleAdvanced() {
        const toggle = document.querySelector(".advanced-toggle");
        const section = document.getElementById("advancedSection");
        toggle.classList.toggle("open");
        section.classList.toggle("show");
      }

      function showStatus(message, type) {
        const status = document.getElementById("status");
        status.textContent = message;
        status.className = "status " + type;
        setTimeout(() => {
          status.className = "status";
        }, 5000);
      }

      // Auto-scan on page load
      window.addEventListener("load", () => {
        setTimeout(scanNetworks, 500);
      });
    </script>
  </body>
</html>
